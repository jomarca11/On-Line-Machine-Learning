
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="author" content="MarkdownViewer++" />
        <title>TFM_Largo_Plazo.md</title>
        <style type="text/css">
            
/* Avoid page breaks inside the most common attributes, especially for exports (i.e. PDF) */
td, h1, h2, h3, h4, h5, p, ul, ol, li {
    page-break-inside: avoid; 
}

        </style>
      </head>
    <body>
        <pre><code class="language-python">import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from river import drift
from river import time_series, evaluate
from river import datasets,compose
from river import linear_model,tree,preprocessing,optim
import calendar,math, datetime as dt
</code></pre>
<h2 id="predicciones-a-largo-plazo">2.2 Predicciones a Largo Plazo</h2>
<p>En este apartado vamos a realizar las tareas relacionadas con las Previsiones a largo Plazo. Aquí vamos a establecer tres horizontes temporales. Un horizonte temporal de 1 mes, 2 meses  y otro horizonte temporal de 3 meses.</p>
<h3 id="aqui-definiremos-las-librerias-y-metodos-necesarios">2.2.1 Aquí definiremos las librerias y métodos necesarios.</h3>
<p>La librería utilizada como en el resto de trabajo, es la riverML, pero en este caso vamos a sobreescribir el método iter_evaluate para adaptar al tratamiento del concept drift cuando este, esté presente.</p>
<pre><code class="language-python">#cargamos los datos de nuevo para independizarlo del resto del notebook
data_orig = pd.read_csv('C:/Users/jrmr/Master/TFM/PEC3/hungary_chickenpox/hungary_chickenpox.csv')
data_orig['Date'] = pd.to_datetime(data_orig['Date'],format=&quot;%d/%m/%Y&quot;) # convertimos a fecha
data_orig.set_index('Date', inplace=True)
label_num_casos =&quot;Num. Casos&quot;
</code></pre>
<pre><code class="language-python">#Si se definen alguna librería varias veces es para no tener que ejecutar todo el código cada vez se hace una prueba
from river import time_series, evaluate
from river import compose
from river import linear_model,tree,preprocessing,optim
import calendar,math, datetime as dt
from river import metrics,base
import typing, statistics
from river.time_series.evaluate import _iter_with_horizon

df_datos_largo_plazo=pd.DataFrame(columns=data_orig.columns)
#Dataframes para recoger los errores y mostrarlos en las gráficas sin tener en cuenta los outliers
df_error_mae_un_mes=pd.DataFrame(columns=data_orig.columns)
df_error_mae_dos_meses=pd.DataFrame(columns=data_orig.columns)
df_error_mae_tres_meses=pd.DataFrame(columns=data_orig.columns)


#Dataframes para recoger los errores y mostrarlos en las gráficas considerando los outliers
df_error_mae_un_mes_sin_outliers=pd.DataFrame(columns=data_orig.columns)
df_error_mae_dos_meses_sin_outliers=pd.DataFrame(columns=data_orig.columns)
df_error_mae_tres_meses_sin_outliers=pd.DataFrame(columns=data_orig.columns)


#Dataframes para recoger los errores base line y mostrarlos en las gráficas sin tener en cuenta los outliers
df_error_mae_un_mes_baseline=pd.DataFrame(columns=data_orig.columns)
df_error_mae_dos_meses_baseline=pd.DataFrame(columns=data_orig.columns)
df_error_mae_tres_meses_baseline=pd.DataFrame(columns=data_orig.columns)


#Dataframes para recoger los errores base line y mostrarlos en las gráficas considerando los outliers
df_error_mae_un_mes_sin_outliers_baseline=pd.DataFrame(columns=data_orig.columns)
df_error_mae_dos_meses_sin_outliers_baseline=pd.DataFrame(columns=data_orig.columns)
df_error_mae_tres_meses_sin_outliers_baseline=pd.DataFrame(columns=data_orig.columns)


def get_ordinal_date(x):
    &quot;&quot;&quot;Returns the ordinal date of a given x date
    &quot;&quot;&quot;     
    return {'ordinal_date': x.toordinal()}

#definimos el modelo ya ajustado con sus hiperparámetros
model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)

#Definimos el modelo SNARIMAX, que generaliza muchos modelos de series temporales en una unica interface y puede ser entrenado online
model_s = (
      get_ordinal_date|
     time_series.SNARIMAX(
         p=4,
         d=0,
         q=9,
         m=52,
         sp=4,
         sq=9,
         regressor=(
             preprocessing.StandardScaler() | 
             linear_model.LinearRegression(
                 intercept_init=110,
                 optimizer=optim.SGD(0.001),
                 intercept_lr=0.3
             )
         )
     )
 )

#Redefinimos el metodo iter_evaluate, para poder sacar las métricas y crear la tabla de resultados y las gráficas, solo para tratar outliers o
def iter_evaluate(
    dataset: base.typing.Dataset,
    model: time_series.base.Forecaster,
    metric: metrics.base.RegressionMetric,
    horizon: int,
    agg_func: typing.Callable[[list[float]], float] = None,
    grace_period: int = None,
    outlier_value=0
):
    &quot;&quot;&quot;Evaluates the performance of a forecaster on a time series dataset and yields results.
    This does exactly the same as `evaluate.progressive_val_score`. The only difference is that
    this function returns an iterator, yielding results at every step. This can be useful if you
    want to have control over what you do with the results. For instance, you might want to plot
    the results.
    Parameters
    ----------
    @dataset
        A sequential time series.
    @model
        A forecaster.
    @metric
        A regression metric.
    @horizon : time horizon to forecast
    @agg_func :function to aggregate the error metrics [mean,.. ]
    @grace_period
        Initial period during which the metric is not updated. This is to fairly evaluate models
        which need a warming up period to start producing meaningful forecasts. The value of this
        parameter is equal to the horizon by default.
    @outlier value
        if &gt;0 it means handling the outliers

    &quot;&quot;&quot;
   
    horizon_metric = (
        time_series.HorizonAggMetric(metric, agg_func)
        if agg_func
        else time_series.HorizonMetric(metric)
    )
    steps = _iter_with_horizon(dataset, horizon)
    num_outliers=0
    #y_horizon =la ground truth en el horizonte
    grace_period = horizon if grace_period is None else grace_period
    
    for _ in range(grace_period):
      
        x, y, x_horizon, y_horizon = next(steps)
        if (y&gt;outlier_value and outlier_value&gt;0):
          None
        else:
          model.learn_one(y=y, x=x)  # type: ignore

    
    if (outlier_value&gt;0):#si queremos checker los outliers
      for x, y, x_horizon, y_horizon in steps:
        
          if (y&gt;outlier_value):
              #num_outliers+=1
              None
          else:
            y_pred = model.forecast(horizon, xs=x_horizon)
            horizon_metric.update(y_horizon, y_pred)
            model.learn_one(y=y, x=x)  # type: ignore
            yield x, y, y_pred, horizon_metric,num_outliers
    else:
         for x, y, x_horizon, y_horizon in steps:
            y_pred = model.forecast(horizon, xs=x_horizon)
            horizon_metric.update(y_horizon, y_pred)
            model.learn_one(y=y, x=x)  # type: ignore
            yield x, y, y_pred, horizon_metric#,num_outliers #aqui el num de outliers sera 0 siempre, pero por igualar datos devueltos
          

#Redefinimos el metodo iter_evaluate para tratar el drift
def iter_evaluate_with_drift(
    dataset: base.typing.Dataset,
    model: time_series.base.Forecaster,
    metric: metrics.base.RegressionMetric,
    horizon: int,
    agg_func: typing.Callable[[list[float]], float] = None,
    grace_period: int = None,
    outlier_value=0,
    check_drift=False,
    model_to_check=&quot;snarimax&quot;
):
    &quot;&quot;&quot;Evaluates the performance of a forecaster on a time series dataset and yields results.
    This does exactly the same as `evaluate.progressive_val_score`. The only difference is that
    this function returns an iterator, yielding results at every step. This can be useful if you
    want to have control over what you do with the results. For instance, you might want to plot
    the results.
    Parameters
    ----------
    @dataset
        A sequential time series.
    @model
        A forecaster.
    @metric
        A regression metric.
   @horizon : time horizon to forecast
   @agg_func :function to aggregate the error metrics [mean,.. ]
  @grace_period
        Initial period during which the metric is not updated. This is to fairly evaluate models
        which need a warming up period to start producing meaningful forecasts. The value of this
        parameter is equal to the horizon by default.
    @outlier value
        if &gt;0 it means handling the outliers, for this version of iter_evaluate_with drift outlier_value always greater than 0
    @check_drift: if drift has to be checked or not
    @model_to_check: which model needs to be reset if drift occurs.
    &quot;&quot;&quot;
       
    horizon_metric = (
        time_series.HorizonAggMetric(metric, agg_func)
        if agg_func
        else time_series.HorizonMetric(metric)
    )
    steps = _iter_with_horizon(dataset, horizon)
    
    #y_horizon =la ground truth en el horizonte
    grace_period = horizon if grace_period is None else grace_period

    adwin=drift.ADWIN(10)
    lista_drifts=[]
   
    for _ in range(grace_period):
      
        x, y, x_horizon, y_horizon = next(steps)
        if (y&gt;outlier_value and outlier_value&gt;0):
          None
        else:
          model.learn_one(y=y, x=x)  # type: ignore

    if check_drift==True:
      for x, y, x_horizon, y_horizon in steps:
        adwin.update(y)
        if adwin.drift_detected:
          adwin=drift.ADWIN(10)
          lista_drifts.append(x)
          if model_to_check==&quot;snarimax&quot;:
            
            model= (
                    get_ordinal_date|
                  time_series.SNARIMAX(
                      p=4,
                      d=0,
                      q=9,
                      m=52,
                      sp=4,
                      sq=9,
                      regressor=(
                          preprocessing.StandardScaler() | 
                          linear_model.LinearRegression(
                              intercept_init=110,
                              optimizer=optim.SGD(0.001),
                              intercept_lr=0.3
                          )
                      )
                  )
              )
          else:
            model.clone()
        if (y&lt;=outlier_value): #Solo contemplamos los valores que no son outliers
            model.learn_one(y=y, x=x)  # type: ignore
            y_pred = model.forecast(horizon, xs=x_horizon)
            horizon_metric.update(y_horizon, y_pred)
            yield x, y, y_pred, horizon_metric,lista_drifts
            
    else:
      
        for x, y, x_horizon, y_horizon in steps:
          if (y&lt;=outlier_value):
            y_pred = model.forecast(horizon, xs=x_horizon)
            horizon_metric.update(y_horizon, y_pred)
            model.learn_one(y=y, x=x)  # type: ignore
            yield x, y, y_pred, horizon_metric,lista_drifts

#-------------------------------------------------------------------------------------#
#Método que entrena el modelo y crea las métricas
def evaluate_forecasting(modelo,data,ax,column,horizonte,outlier_value=0, model ='snarimax'):
    &quot;&quot;&quot;Evaluates the performance of a forecaster on a time series dataset and yields results, through iter_evaluate method
    and gathers metrics and plots the results predictions vs ground truth.
    This method is only intended for outliers. Handling outliers or not depending on the vlue of outlier_value
          
    Parameters
    ----------
    @dataset
        A sequential time series.
    @model
        A forecaster.
   
    @horizon horizon to forecast
    @outlier value
        if &gt;0 it means handling the outliers
    @ax: axis where to plot predictions vs ground truth.
    @column: which data column is handled (Hungarian county)
    @model:label to handle error messages accordingly

    &quot;&quot;&quot;
    metricas = iter_evaluate(
        dataset=data.T.iteritems(),
        model=modelo,
        metric=metrics.MAE(),
        horizon=horizonte,
        agg_func=statistics.mean,
        outlier_value=outlier_value
        )
    dates = []
    y_trues = []
    y_preds = []
    lista=[]
    
    horizon=horizonte
    mensaje=&quot;&quot;
    mensaje_outliers=&quot;&quot;
    num_outliers=0
    i=0
    if outlier_value==0:
      mensaje =&quot;1 MAE Datos sin drift y sin tratar outliers con horizonte= &quot;
      
    else:
      mensaje =&quot;2 MAE Datos sin drift y tratando outliers con horizonte= &quot;
       
    for m in metricas:
          dates.append(m[0])
          y_trues.append(m[1])
          y_preds.append(m[2][horizon-1])
          lista.append(m[3].get())
          #num_outliers=m[4]
          
          if model=='snarimax':
            if outlier_value &gt;0:
              if horizonte==4:
                df_error_mae_un_mes.at[i,column] =round(m[3].get(),2)
              elif horizonte==8:
                df_error_mae_dos_meses.at[i,column] =round(m[3].get(),2)
              elif horizonte==12:
                df_error_mae_tres_meses.at[i,column] =round(m[3].get(),2)
            else:
              if horizonte==4:
                df_error_mae_un_mes_sin_outliers.at[i,column] =round(m[3].get(),2)
              elif horizonte==8:
                df_error_mae_dos_meses_sin_outliers.at[i,column] =round(m[3].get(),2)
              elif horizonte==12:
                df_error_mae_tres_meses_sin_outliers.at[i,column] =round(m[3].get(),2)
          else:
            if outlier_value &gt;0:
              if horizonte==4:
                df_error_mae_un_mes_baseline.at[i,column] =round(m[3].get(),2)
              elif horizonte==8:
                df_error_mae_dos_meses_baseline.at[i,column] =round(m[3].get(),2)
              elif horizonte==12:
                df_error_mae_tres_meses_baseline.at[i,column] =round(m[3].get(),2)
            else:
              if horizonte==4:
                df_error_mae_un_mes_sin_outliers_baseline.at[i,column] =round(m[3].get(),2)
              elif horizonte==8:
                df_error_mae_dos_meses_sin_outliers_baseline.at[i,column] =round(m[3].get(),2)
              elif horizonte==12:
                df_error_mae_tres_meses_sin_outliers_baseline.at[i,column] =round(m[3].get(),2)

          i+=1
    metric=round(sum(lista)/len(lista),2) #average of MAES for one horizon forecast
    # Plot the results
    ax=ax
    ax.grid(alpha=0.75)
    ax.plot(dates, y_trues, lw=3, color='#2ecc71', alpha=0.8, label='Ground truth')
    ax.plot(dates, y_preds, lw=3, color='#e74c3c', alpha=0.8, label='Prediction')
    ax.legend()
    ax.set_title(&quot;MAE &quot;+str(metric))
    ax.set_xlabel(column)
    ax.set_ylabel(label_num_casos)
    
    df_datos_largo_plazo.at[mensaje+ ' '+str(horizonte)+' semanas, modelo = '+model, column] = metric
 
    if outlier_value==0:
      std=round(data.std(),2)
      mean=round(data.mean(),2)
      df_datos_largo_plazo.at['STD', column] = std
      df_datos_largo_plazo.at['MEAN', column] = mean
      outlier_value= mean+(3*std)
      #Contador de outliers
      num_outliers=df_data[df_data&gt;outlier_value].count()
      df_datos_largo_plazo.at['Num Outliers', column] = num_outliers

</code></pre>
<pre><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

~\AppData\Local\Temp\ipykernel_23216\703029908.py in &lt;module&gt;
      8 from river.time_series.evaluate import _iter_with_horizon
      9 
---&gt; 10 df_datos_largo_plazo=pd.DataFrame(columns=data_orig.columns)
     11 #Dataframes para recoger los errores y mostrarlos en las gráficas sin tener en cuenta los outliers
     12 df_error_mae_un_mes=pd.DataFrame(columns=data_orig.columns)


NameError: name 'pd' is not defined
</code></pre>
<h3 id="graficas-de-los-diferentes-modelos-comparando-las-predicciones-en-el-horizonte-h-con-los-valores-verdaderos-h-t">2.2.2 Gráficas de los diferentes modelos comparando las predicciones en el horizonte h, con los valores verdaderos h-t.</h3>
<p>Se puede comprobar como a mayor horizonte en la predicción la métrica de error seleccionada MAE aumenta. Con lo cual a mayor horizonte, menor precisión en la prediccion.</p>
<h4 id="graficas-y-comportamiento-del-modelo-snarimax-con-horizonte-a-1-mes-4-semanas">2.2.2.1 Gráficas y comportamiento del modelo SNARIMAX con horizonte a 1 mes ( 4 semanas ).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-1-mes-4-semanas.sin-tratar-los-outliers">2.2.2.1.1 Gráfica y Comportamiento de la prediccion a 1 mes (4 semanas). Sin tratar los outliers.</h5>
<pre><code class="language-python">
fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_s,df_data,ax,label,horizonte=4,outlier_value=0)
  
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_8_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-1-mes-4-semanas.tratando-los-outliers">2.2.2.1.2 Gráfica y Comportamiento de la prediccion a 1 mes (4 semanas). Tratando los outliers.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_s,df_data,ax,label,horizonte=4,outlier_value=outlier_value)
        #evaluate_model(model_hft_reg.clone(),df_data,label,ax,etiqueta=&quot;hft&quot;,check_drift=False,check_outliers=False,is_data_drifted=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_10_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-snarimax-con-horizonte-a-2-meses-8-semanas">2.2.2.2 Gráficas y comportamiento del modelo SNARIMAX con horizonte a 2 meses (8 semanas).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-2-meses-8-semanas.sin-tratar-los-outliers">2.2.2.2.1 Gráfica y Comportamiento de la predicción a 2 meses (8 semanas). Sin tratar los outliers.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_s,df_data,ax,label,horizonte=8,outlier_value=0)
  
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_13_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-2-meses-8-semanas.tratando-los-outliers">2.2.2.2.2 Gráfica y Comportamiento de la predicción a 2 meses (8 semanas). Tratando los outliers.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_s,df_data,ax,label,horizonte=8,outlier_value=outlier_value)
       
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_15_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-snarimax-con-horizonte-a-3-meses-12-semanas">2.2.2.3 Gráficas y comportamiento del modelo SNARIMAX con horizonte a 3 meses (12 semanas).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-3-meses-12-semanas.sin-tratar-los-outliers">2.2.2.3.1 Gráfica y Comportamiento de la predicción a 3 meses (12 semanas). Sin tratar los outliers.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_s,df_data,ax,label,horizonte=12,outlier_value=0)
  
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_18_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-3-meses-12-semanas.tratando-los-outliers">2.2.2.3.2 Gráfica y Comportamiento de la predicción a 3 meses (12 semanas). Tratando los outliers.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_s,df_data,ax,label,horizonte=12,outlier_value=outlier_value)
       
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_20_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-holtwinter-base-line-con-horizonte-a-1-mes">2.2.2.4 Gráficas y comportamiento del modelo HoltWinter (Base Line) con horizonte a 1 mes.</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-1-mes-4-semanas.sin-tratar-los-outliers-1">2.2.2.4.1 Gráfica y Comportamiento de la prediccion a 1 mes (4 semánas). Sin tratar los outliers.</h5>
<pre><code class="language-python">
fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_dummy,df_data,ax,label,horizonte=4,outlier_value=0,model='baseline')
  
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, HoltWinter (Base Line) a un mes sin tratar los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_23_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-1-mes-4-semanas.tratando-los-outliers-1">2.2.2.1.2 Gráfica y Comportamiento de la prediccion a 1 mes (4 semánas). Tratando los outliers.</h5>
<pre><code class="language-python">_baselinefig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_dummy,df_data,ax,label,horizonte=4,outlier_value=outlier_value,model='baseline')
        #evaluate_model(model_hft_reg.clone(),df_data,label,ax,etiqueta=&quot;hft&quot;,check_drift=False,check_outliers=False,is_data_drifted=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, HoltWinter (Base Line) a un mes tratando los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_25_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-holtwinter-base-line-con-horizonte-a-2-meses-8-semanas">2.2.2.5 Gráficas y comportamiento del modelo HoltWinter (Base Line) con horizonte a 2 meses (8 semanas).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-2-meses-8-semanas.sin-tratar-los-outliers-1">2.2.2.5.1 Gráfica y Comportamiento de la prediccion a 2 meses (8 semanas). Sin tratar los outliers.</h5>
<pre><code class="language-python">
fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_dummy,df_data,ax,label,horizonte=8,outlier_value=0,model='baseline')
  
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, HoltWinter (Base Line) a un mes sin tratar los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_28_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-2-meses-8-semanas.tratando-los-outliers-1">2.2.2.5.2 Gráfica y Comportamiento de la prediccion a 2 meses (8 semanas). Tratando los outliers.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_dummy,df_data,ax,label,horizonte=8,outlier_value=outlier_value,model='baseline')
        #evaluate_model(model_hft_reg.clone(),df_data,label,ax,etiqueta=&quot;hft&quot;,check_drift=False,check_outliers=False,is_data_drifted=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, HoltWinter (Base Line) a un mes tratando los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_30_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-holtwinter-base-line-con-horizonte-a-3-meses-12-semanas">2.2.2.6 Gráficas y comportamiento del modelo HoltWinter (Base Line) con horizonte a 3 meses (12 semanas ).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-3-meses-12-semanas.sin-tratar-los-outliers-1">2.2.2.6.1 Gráfica y Comportamiento de la prediccion a 3 meses (12 semanas). Sin tratar los outliers.</h5>
<pre><code class="language-python">
fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_dummy,df_data,ax,label,horizonte=12,outlier_value=0,model='baseline')
  
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, HoltWinter (Base Line) a un mes sin tratar los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_33_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-3-meses-12-semanas.tratando-los-outliers-1">2.2.2.6.2 Gráfica y Comportamiento de la prediccion a 3 meses (12 semanas). Tratando los outliers.</h5>
<pre><code class="language-python">
fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= data_orig.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting(model_dummy,df_data,ax,label,horizonte=12,outlier_value=outlier_value,model='baseline')
  
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, HoltWinter (Base Line) a un mes sin tratar los Outliers&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_35_0.png" alt="png" /></p>
<h3 id="graficas-comparacion-de-la-metrica-de-error-seleccionada-maede-los-distintos-horizontes-con-el-modelo-snarimax-y-baseline">2.2.3 Gráficas, comparación de la métrica de error seleccionada (MAE)de los distintos horizontes con el Modelo SNARIMAX y Baseline.</h3>
<p>Se compara la evolución del error, MAE, de cada uno de los modelos para cada ciudad.En este apartado se puede comprobar que la comparación de los distintos horizontes del modelo SNARIMAX vs distintos horizontes Baseline, en el modelo SNARIMAX se consigue un menor error MAE, tanto en la versión del tratamiento de los outliers como sin tratarlos. También se adivina que a menor horizonte, mayor precisión en las predicciones.</p>
<h4 id="graficas-de-error-y-comportamiento-del-modelo-snarimax-con-varios-horizontes-para-cada-ciudad-sin-tratar-los-outliers">2.2.3.1 Gráficas de error  y comportamiento del modelo SNARIMAX con varios horizontes, para cada ciudad sin tratar los outliers.</h4>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(28, 17))
i = 0
for row in axes:
    for ax in row:
        label=data_orig.columns[i]
        ax.set_title(label)
        df_error_mae_un_mes[label].plot(ax=ax)
        df_error_mae_dos_meses[label].plot(ax=ax)
        df_error_mae_tres_meses[label].plot(ax=ax)
        df_error_mae_un_mes_baseline[label].plot(ax=ax)
        df_error_mae_dos_meses_baseline[label].plot(ax=ax)
        df_error_mae_tres_meses_baseline[label].plot(ax=ax)
        ax.set_xlabel(label_num_casos)
        ax.set_ylabel(&quot;MAE&quot;)
        ax.legend([&quot;SNARIMAX Un Mes&quot;, &quot;SNARIMAX Dos Meses&quot;,&quot;SNARIMAX tres Meses&quot;,&quot;Baseline Un Mes&quot;, &quot;Baseline Dos Meses&quot;,&quot;Baseline tres Meses&quot;]);
        i += 1
fig.suptitle(&quot;Comparación de la métrica de error seleccionada (MAE) Modelo SNARIMAX vs Baseline sin tratar los outliers, para cada ciudad&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_38_0.png" alt="png" /></p>
<h4 id="graficas-de-error-y-comportamiento-del-modelo-holtwinters-baseline-con-varios-horizontes-para-cada-ciudad-tratando-los-outliers">2.2.3.2 Gráficas de error  y comportamiento del modelo HoltWinters (Baseline) con varios horizontes , para cada ciudad tratando los outliers.</h4>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(28, 17))
i = 0
for row in axes:
    for ax in row:
        label=data_orig.columns[i]
        ax.set_title(label)
        df_error_mae_un_mes_sin_outliers[label].plot(ax=ax)
        df_error_mae_dos_meses_sin_outliers[label].plot(ax=ax)
        df_error_mae_tres_meses_sin_outliers[label].plot(ax=ax)
        df_error_mae_un_mes_sin_outliers_baseline[label].plot(ax=ax)
        df_error_mae_dos_meses_sin_outliers_baseline[label].plot(ax=ax)
        df_error_mae_tres_meses_sin_outliers_baseline[label].plot(ax=ax)
        ax.set_xlabel(label_num_casos)
        ax.set_ylabel(&quot;MAE&quot;)
        ax.legend([&quot;SNARIMAX Un Mes&quot;, &quot;SNARIMAX Dos Meses&quot;,&quot;SNARIMAX tres Meses&quot;,&quot;Baseline Un Mes&quot;, &quot;Baseline Dos Meses&quot;,&quot;Baseline tres Meses&quot;]);
        i += 1
fig.suptitle(&quot;Comparación de la métrica de error seleccionada (MAE) Modelo SNARIMAX vs Baseline tratando los outliers, para cada ciudad&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_40_0.png" alt="png" /></p>
<h3 id="graficas-de-cada-modelo-para-cada-ciudad-comparando-la-evolucion-del-error-tratando-los-outliers-vs-sin-tratarlos">2.2.4  Graficas de cada modelo <strong>para cada ciudad</strong> comparando la evolución del error tratando los outliers vs sin tratarlos.</h3>
<p>Se puede ver que as predicciones a mas corto plazo presentan menos error y que a su vez, el tratamiento de los outliers, nos conduce a unas predicciones mas precisas, menos error.</p>
<h4 id="modelo-snarimax-con-los-distintos-horizontes-12-y-3-meses-tratando-outliers-y-sin-tratar">2.2.4.1 Modelo SNARIMAX con los distintos horizontes (1,2 y 3 meses) tratando outliers y sin tratar.</h4>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(28, 17))
i = 0
for row in axes:
    for ax in row:
        label=data_orig.columns[i]
        ax.set_title(label)
        df_error_mae_un_mes[label].plot(ax=ax)
        df_error_mae_dos_meses[label].plot(ax=ax)
        df_error_mae_tres_meses[label].plot(ax=ax)
        df_error_mae_un_mes_sin_outliers[label].plot(ax=ax)
        df_error_mae_dos_meses_sin_outliers[label].plot(ax=ax)
        df_error_mae_tres_meses_sin_outliers[label].plot(ax=ax)
        ax.set_xlabel(label_num_casos)
        ax.set_ylabel(&quot;MAE&quot;)
        ax.legend([&quot;SNMAX Un Mes&quot;, &quot;SNMAX Dos Meses&quot;,&quot;SNMAX tres Meses&quot;,&quot;SNMAX Un M sin out&quot;, &quot;SNMAX Dos M sin out&quot;,&quot;SNMAX tres M sin out&quot;]);
        i += 1
fig.suptitle(&quot;Comparación de la métrica de error seleccionada (MAE) Modelo SNARIMAX, tratando outliers  vs sin tratar los outliers, para cada ciudad&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_43_0.png" alt="png" /></p>
<h4 id="modelo-baseline-con-los-distintos-horizontes-12-y-3-meses-tratando-outliers-y-sin-tratar">2.2.4.2 Modelo Baseline con los distintos horizontes (1,2 y 3 meses) tratando outliers y sin tratar.</h4>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(28, 17))
i = 0
for row in axes:
    for ax in row:
        label=data_orig.columns[i]
        ax.set_title(label)
        df_error_mae_un_mes_baseline[label].plot(ax=ax)
        df_error_mae_dos_meses_baseline[label].plot(ax=ax)
        df_error_mae_tres_meses_baseline[label].plot(ax=ax)
        df_error_mae_un_mes_sin_outliers_baseline[label].plot(ax=ax)
        df_error_mae_dos_meses_sin_outliers_baseline[label].plot(ax=ax)
        df_error_mae_tres_meses_sin_outliers_baseline[label].plot(ax=ax)
        ax.set_xlabel(label_num_casos)
        ax.set_ylabel(&quot;MAE&quot;)
        ax.legend([&quot;Bline Un Mes&quot;, &quot;Bline Dos Meses&quot;,&quot;Bline tres Meses&quot;,&quot;Bline Un M sin out&quot;, &quot;Bline Dos M sin out&quot;,&quot;Bline tres M sin out&quot;]);
        i += 1
fig.suptitle(&quot;Comparación de la métrica de error seleccionada (MAE) Modelo Baseline, tratando outliers  vs sin tratar los outliers, para cada ciudad&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_45_0.png" alt="png" /></p>
<h3 id="aqui-vamos-a-introducir-un-concept-drift-artificial-para-ver-como-se-comportan-las-predicciones-a-largo-plazo">2.2.5 Aqui vamos a introducir un Concept Drift artificial para ver como se comportan las predicciones a largo plazo</h3>
<pre><code class="language-python">df_data_orig_drifted=data_orig.copy()
for column in df_data_orig_drifted.columns:
   for index, value in df_data_orig_drifted[column].items(): 
    if (index &gt;=pd.Timestamp('2008-01-01') and index &lt;=pd.Timestamp('2011-12-30') ):
        df_data_orig_drifted[column].at[index]= value *0.3
</code></pre>
<pre><code class="language-python">#Método que entrena el modelo y crea las métricas

#Dataframes para recoger los errores y mostrarlos en las gráficas sin tener en cuenta los outliers
df_error_mae_un_mes_sin_concept=pd.DataFrame(columns=data_orig.columns)
df_error_mae_dos_meses_sin_concept=pd.DataFrame(columns=data_orig.columns)
df_error_mae_tres_meses_sin_concept=pd.DataFrame(columns=data_orig.columns)


#Dataframes para recoger los errores y mostrarlos en las gráficas tratando concept drift
df_error_mae_un_mes_con_concept=pd.DataFrame(columns=data_orig.columns)
df_error_mae_dos_meses_con_concept=pd.DataFrame(columns=data_orig.columns)
df_error_mae_tres_meses_con_concept=pd.DataFrame(columns=data_orig.columns)


#Dataframes para recoger los errores base line y mostrarlos en las gráficas sin tener en cuenta los outliers
df_error_mae_un_mes_baseline_sin_concept=pd.DataFrame(columns=data_orig.columns)
df_error_mae_dos_meses_baseline_sin_concept=pd.DataFrame(columns=data_orig.columns)
df_error_mae_tres_meses_baseline_sin_concept=pd.DataFrame(columns=data_orig.columns)


#Dataframes para recoger los errores base line y mostrarlos en las gráficas considerando los outliers
df_error_mae_un_mes_baseline_con_concept=pd.DataFrame(columns=data_orig.columns)
df_error_mae_dos_meses_baseline_con_concept=pd.DataFrame(columns=data_orig.columns)
df_error_mae_tres_meses_baseline_con_concept=pd.DataFrame(columns=data_orig.columns)

#Redefinimos el metodo iter_evaluate, para poder sacar las métricas y crear la tabla de resultados y las gráficas, solo para tratar drift o no
def evaluate_forecasting_with_drift(modelo,data,ax,column,horizonte,outlier_value=0, model ='snarimax',check_drift=False):
    &quot;&quot;&quot;Evaluates the performance of a forecaster on a time series dataset and yields results, through iter_evaluate_with_drift method
    and gathers metrics and plots the results predictions vs ground truth.
    This method is only intended for outliers. Handling outliers or not depending on the vlue of outlier_value
          
    Parameters
    ----------
    @dataset
        A sequential time series.
    @model
        A forecaster.
   
    @horizon horizon to forecast
    @outlier value
        if &gt;0 it means handling the outliers
    @ax: axis where to plot predictions vs ground truth.
    @column: which data column is handled (Hungarian county)
    @model:label to handle error messages accordingly
    @check_drift: If drift has to be checked or not
    &quot;&quot;&quot;
  
    metricas = iter_evaluate_with_drift(
        dataset=data.T.iteritems(),
        model=modelo,
        metric=metrics.MAE(),
        horizon=horizonte,
        agg_func=statistics.mean,
        outlier_value=outlier_value,
        check_drift=check_drift,
        model_to_check=model
        )
    dates = []
    y_trues = []
    y_preds = []
    lista=[]
    lista_drifts=[]
    horizon=horizonte
    std=round(data.std(),2)
    mean=round(data.mean(),2)
    i=0
    if check_drift:
      mensaje =&quot;3 MAE Datos con drift en datos y tratando el drift con horizonte= &quot;
      mensaje_drifts =&quot;5 Num Drifts Datos con drift en datos y tratando el drift con horizonte= &quot;
    else:
      mensaje =&quot;4 MAE Datos con drift en datos y sin tratar el drift con horizonte= &quot;
      
    for m in metricas:
          
          dates.append(m[0])
          y_trues.append(m[1])
          y_preds.append(m[2][horizon-1])
          lista.append(m[3].get())
          lista_drifts=m[4]
          if model=='snarimax':
            if check_drift:
              if horizonte==4:
                df_error_mae_un_mes_con_concept.at[i,column] =round(m[3].get(),2)
              elif horizonte==8:
                df_error_mae_dos_meses_con_concept.at[i,column] =round(m[3].get(),2)
              elif horizonte==12:
                df_error_mae_tres_meses_con_concept.at[i,column] =round(m[3].get(),2)
            else:
              if horizonte==4:
                df_error_mae_un_mes_sin_concept.at[i,column] =round(m[3].get(),2)
              elif horizonte==8:
                df_error_mae_dos_meses_sin_concept.at[i,column] =round(m[3].get(),2)
              elif horizonte==12:
                df_error_mae_tres_meses_sin_concept.at[i,column] =round(m[3].get(),2)
          else: #model= baseline
            if  check_drift:
              if horizonte==4:
                df_error_mae_un_mes_baseline_con_concept.at[i,column] =round(m[3].get(),2)
              elif horizonte==8:
                df_error_mae_dos_meses_baseline_con_concept.at[i,column] =round(m[3].get(),2)
              elif horizonte==12:
                df_error_mae_tres_meses_baseline_con_concept.at[i,column] =round(m[3].get(),2)
            else:
              if horizonte==4:
                df_error_mae_un_mes_baseline_sin_concept.at[i,column] =round(m[3].get(),2)
              elif horizonte==8:
                df_error_mae_dos_meses_baseline_sin_concept.at[i,column] =round(m[3].get(),2)
              elif horizonte==12:
                df_error_mae_tres_meses_baseline_sin_concept.at[i,column] =round(m[3].get(),2)

          i+=1
    
    metric=round(sum(lista)/len(lista),2)#average of MAES
    # Plot the results
    ax=ax
    for drift in lista_drifts:
              ax.axvline(drift, color='red')
    ax.grid(alpha=0.75)
    ax.plot(dates, y_trues, lw=3, color='#2ecc71', alpha=0.8, label='Ground truth')
    ax.plot(dates, y_preds, lw=3, color='#e74c3c', alpha=0.8, label='Prediction')
    ax.legend()
    ax.set_title(&quot;MAE &quot;+str(metric))
    ax.set_xlabel(column)
    ax.set_ylabel(label_num_casos)
    df_datos_largo_plazo.at['STD', column] = std
    df_datos_largo_plazo.at['MEAN', column] = mean
    df_datos_largo_plazo.at[mensaje+ ' '+str(horizonte)+' semanas' +' modelo: '+model, column] = metric
    if check_drift:
      df_datos_largo_plazo.at[mensaje_drifts+' '+str(horizonte)+' semanas' +' modelo ='+model, column] = len(lista_drifts)

  

</code></pre>
<h4 id="graficas-y-comportamiento-del-modelo-snarimax-con-horizonte-a-1-meses-4-semanas">2.2.5.1 Gráficas y comportamiento del modelo SNARIMAX con horizonte a 1 meses (4 semanas).</h4>
<p>En este apartado vamos a ver igual que ocurria con el Nowcasting que si se trata el Concept Drift cuando este aparece, el modelo se comporta mejor en cuanto a la métrica seleccionada.</p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-1-mes-4-semenas.sin-tratar-el-concept-drift">2.2.5.1.1 Gráfica y comportamiento de la predicción a 1 mes (4 semenas). Sin tratar el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_s,df_data,ax,label,horizonte=4,outlier_value=outlier_value,model=&quot;snarimax&quot;,check_drift=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_51_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-1-mes-4-semenas.tratando-el-concept-drift">2.2.5.1.2 Gráfica y comportamiento de la predicción a 1 mes (4 semenas).Tratando el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_s,df_data,ax,label,horizonte=4,outlier_value=outlier_value,model=&quot;snarimax&quot;,check_drift=True)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_53_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-snarimax-con-horizonte-a-2-meses-8-semanas-1">2.2.5.2 Gráficas y comportamiento del modelo SNARIMAX con horizonte a 2 meses (8 semanas).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-2-meses-8-semenas.sin-tratar-el-concept-drift">2.2.5.2.1 Gráfica y comportamiento de la predicción a 2 meses (8 semenas). Sin tratar el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_s,df_data,ax,label,horizonte=8,outlier_value=outlier_value,model=&quot;snarimax&quot;,check_drift=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_56_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-2-meses-8-semenas.tratando-el-concept-drift">2.2.5.1.2 Gráfica y comportamiento de la predicción a 2 meses (8 semenas).Tratando el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_s,df_data,ax,label,horizonte=8,outlier_value=outlier_value,model=&quot;snarimax&quot;,check_drift=True)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_58_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-snarimax-con-horizonte-a-3-meses-12-semanas-1">2.2.5.3 Gráficas y comportamiento del modelo SNARIMAX con horizonte a 3 meses (12 semanas).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-3-meses-12-semenas.sin-tratar-el-concept-drift">2.2.5.3.1 Gráfica y comportamiento de la predicción a 3 meses (12 semenas). Sin tratar el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_s,df_data,ax,label,horizonte=12,outlier_value=outlier_value,model=&quot;snarimax&quot;,check_drift=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_61_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-3-meses-12-semenas.tratando-el-concept-drift">2.2.5.1.2 Gráfica y comportamiento de la predicción a 3 meses (12 semenas).Tratando el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_s,df_data,ax,label,horizonte=12,outlier_value=outlier_value,model=&quot;snarimax&quot;,check_drift=True)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_63_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-holtwinter-base-line-con-horizonte-a-1-mes-4-semanas">2.2.5.1 Gráficas y comportamiento del modelo HoltWinter (Base Line) con horizonte a 1 mes (4 semanas).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-1-mes-4-semenas.sin-tratar-el-concept-drift-1">2.2.5.1.1 Gráfica y comportamiento de la predicción a 1 mes (4 semenas). Sin tratar el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_dummy,df_data,ax,label,horizonte=4,outlier_value=outlier_value,model=&quot;baseline&quot;,check_drift=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_66_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-1-mes-4-semenas.tratando-el-concept-drift-1">2.2.5.1.2 Gráfica y comportamiento de la predicción a 1 mes (4 semenas).Tratando el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_dummy,df_data,ax,label,horizonte=4,outlier_value=outlier_value,model=&quot;baseline&quot;,check_drift=True)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_68_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-holtwinter-base-line-con-horizonte-a-2-meses-8-semanas-1">2.2.5.2 Gráficas y comportamiento del modelo HoltWinter (Base Line) con horizonte a 2 meses (8 semanas).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-2-meses-8-semenas.sin-tratar-el-concept-drift-1">2.2.5.2.1 Gráfica y comportamiento de la predicción a 2 meses (8 semenas). Sin tratar el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_dummy,df_data,ax,label,horizonte=8,outlier_value=outlier_value,model=&quot;baseline&quot;,check_drift=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_71_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-2-meses-8-semenas.tratando-el-concept-drift-1">2.2.5.1.2 Gráfica y comportamiento de la predicción a 2 meses (8 semenas).Tratando el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_dummy,df_data,ax,label,horizonte=8,outlier_value=outlier_value,model=&quot;baseline&quot;,check_drift=True)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_73_0.png" alt="png" /></p>
<h4 id="graficas-y-comportamiento-del-modelo-holtwinter-base-line-con-horizonte-a-3-meses-12-semanas-1">2.2.5.3 Gráficas y comportamiento del modelo HoltWinter (Base Line) con horizonte a 3 meses (12 semanas).</h4>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-3-meses-12-semenas.sin-tratar-el-concept-drift-1">2.2.5.3.1 Gráfica y comportamiento de la predicción a 3 meses (12 semenas). Sin tratar el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_dummy,df_data,ax,label,horizonte=12,outlier_value=outlier_value,model=&quot;baseline&quot;,check_drift=False)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, sin tratar el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_76_0.png" alt="png" /></p>
<h5 id="grafica-y-comportamiento-de-la-prediccion-a-3-meses-12-semenas.tratando-el-concept-drift-1">2.2.5.1.2 Gráfica y comportamiento de la predicción a 3 meses (12 semenas).Tratando el Concept Drift.</h5>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(25, 14))
i = 0
for row in axes:
    for ax in row:
        df_data= df_data_orig_drifted.iloc[:, i]
        media=df_data.mean()
        std=df_data.std()
        outlier_value=media+(3*std)
        model_dummy=time_series.HoltWinters(alpha=0.6,beta=0.04,gamma=0.9)
        label=data_orig.columns[i]
        
        model_s = ( get_ordinal_date|  time_series.SNARIMAX(
                p=4,
                d=0,
                q=9,
                m=52,
                sp=4,
                sq=9,
                regressor=(
                    preprocessing.StandardScaler() | 
                    linear_model.LinearRegression(
                        intercept_init=110,
                        optimizer=optim.SGD(0.001),
                        intercept_lr=0.3
                    )
                )
            )
        )
        evaluate_forecasting_with_drift(model_dummy,df_data,ax,label,horizonte=12,outlier_value=outlier_value,model=&quot;baseline&quot;,check_drift=True)
        i += 1
fig.suptitle(&quot;Comportamiento del modelo, tratando el Concept Drift&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_78_0.png" alt="png" /></p>
<h3 id="graficas-comparacion-de-la-metrica-de-error-seleccionada-maede-los-distintos-horizontes-con-el-modelo-snarimax-y-baseline-1">2.2.6 Gráficas, comparación de la métrica de error seleccionada (MAE)de los distintos horizontes con el Modelo SNARIMAX y Baseline.</h3>
<p>Se compara la evolución del error, MAE, de cada uno de los modelos para cada ciudad.En este apartado se puede comprobar que la comparación de los distintos horizontes del modelo SNARIMAX vs distintos horizontes Baseline, en el modelo SNARIMAX se consigue un menor error MAE, tanto en la versión del tratamiento del Concept Drift como sin tratarlo. También se adivina que a menor horizonte, mayor precisión en las predicciones.</p>
<h4 id="graficas-de-error-y-comportamiento-del-modelo-snarimax-con-varios-horizontes-para-cada-ciudad-sin-tratar-el-concept-drift">2.2.6.1 Gráficas de error  y comportamiento del modelo SNARIMAX con varios horizontes, para cada ciudad sin tratar el Concept Drift.</h4>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(28, 17))
i = 0
for row in axes:
    for ax in row:
        label=data_orig.columns[i]
        ax.set_title(label)
        df_error_mae_un_mes_sin_concept[label].plot(ax=ax)
        df_error_mae_dos_meses_sin_concept[label].plot(ax=ax)
        df_error_mae_tres_meses_sin_concept[label].plot(ax=ax)
        df_error_mae_un_mes_baseline_sin_concept[label].plot(ax=ax)
        df_error_mae_dos_meses_baseline_sin_concept[label].plot(ax=ax)
        df_error_mae_tres_meses_baseline_sin_concept[label].plot(ax=ax)
        ax.set_xlabel(label_num_casos)
        ax.set_ylabel(&quot;MAE&quot;)
        ax.legend([&quot;SNARIMAX Un Mes&quot;, &quot;SNARIMAX Dos Meses&quot;,&quot;SNARIMAX tres Meses&quot;,&quot;Baseline Un Mes&quot;, &quot;Baseline Dos Meses&quot;,&quot;Baseline tres Meses&quot;]);
        i += 1
fig.suptitle(&quot;Comparación de la métrica de error seleccionada (MAE) Modelo SNARIMAX vs HoltWinters(Baseline) sin tratar el Concept Drift, para cada ciudad&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_81_0.png" alt="png" /></p>
<h4 id="graficas-de-error-y-comportamiento-del-modelo-holtwinters-baseline-con-varios-horizontes-para-cada-ciudad-tratando-el-concept-drift">2.2.6.2 Gráficas de error  y comportamiento del modelo HoltWinters (Baseline) con varios horizontes , para cada ciudad tratando el Concept Drift.</h4>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(28, 17))
i = 0
for row in axes:
    for ax in row:
        label=data_orig.columns[i]
        ax.set_title(label)
        df_error_mae_un_mes_con_concept[label].plot(ax=ax)
        df_error_mae_dos_meses_con_concept[label].plot(ax=ax)
        df_error_mae_tres_meses_con_concept[label].plot(ax=ax)
        df_error_mae_un_mes_baseline_con_concept[label].plot(ax=ax)
        df_error_mae_dos_meses_baseline_con_concept[label].plot(ax=ax)
        df_error_mae_tres_meses_baseline_con_concept[label].plot(ax=ax)
        ax.set_xlabel(label_num_casos)
        ax.set_ylabel(&quot;MAE&quot;)
        ax.legend([&quot;SNARIMAX Un Mes&quot;, &quot;SNARIMAX Dos Meses&quot;,&quot;SNARIMAX tres Meses&quot;,&quot;Baseline Un Mes&quot;, &quot;Baseline Dos Meses&quot;,&quot;Baseline tres Meses&quot;]);
        i += 1
fig.suptitle(&quot;Comparación de la métrica de error seleccionada (MAE) Modelo SNARIMAX vs HoltWinters(Baseline) tratando el Concept Drift, para cada ciudad&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_83_0.png" alt="png" /></p>
<h3 id="graficas-de-cada-modelo-para-cada-ciudad-comparando-la-evolucion-del-error-tratando-el-concept-drift-vs-sin-tratarlo">2.2.7  Graficas de cada modelo <strong>para cada ciudad</strong> comparando la evolución del error tratando el Concept Drift vs sin Tratarlo.</h3>
<p>Se puede ver que as predicciones a mas corto plazo presentan menos error y que a su vez, el tratamiento del Concept drif, nos conduce a unas predicciones mas precisas, menos error para cada  uno de los diferentes modelos aunque el modelo SNARIMAX, saca mejores prestaciones que el HoltWinters (Base Line)</p>
<h4 id="modelo-snarimax-con-los-distintos-horizontes-12-y-3-meses-tratando-el-concept-drift-vs-sin-tratar">2.2.4.1 Modelo SNARIMAX con los distintos horizontes (1,2 y 3 meses) tratando el Concept Drift vs Sin tratar.</h4>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(28, 17))
i = 0
for row in axes:
    for ax in row:
        label=data_orig.columns[i]
        ax.set_title(label)
        df_error_mae_un_mes[label].plot(ax=ax)
        df_error_mae_dos_meses[label].plot(ax=ax)
        df_error_mae_tres_meses[label].plot(ax=ax)
        df_error_mae_un_mes_sin_outliers[label].plot(ax=ax)
        df_error_mae_dos_meses_sin_outliers[label].plot(ax=ax)
        df_error_mae_tres_meses_sin_outliers[label].plot(ax=ax)
        ax.set_xlabel(label_num_casos)
        ax.set_ylabel(&quot;MAE&quot;)
        ax.legend([&quot;SNMAX Un Mes&quot;, &quot;SNMAX Dos Meses&quot;,&quot;SNMAX tres Meses&quot;,&quot;SNMAX Un M sin out&quot;, &quot;SNMAX Dos M sin out&quot;,&quot;SNMAX tres M sin out&quot;]);
        i += 1
fig.suptitle(&quot;Comparación de la métrica de error seleccionada (MAE) Modelo SNARIMAX, tratando outliers  vs sin tratar los outliers, para cada ciudad&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_86_0.png" alt="png" /></p>
<h4 id="modelo-baseline-con-los-distintos-horizontes-12-y-3-meses-tratando-el-concept-drift-vs-sin-tratar">2.2.4.2 Modelo Baseline con los distintos horizontes (1,2 y 3 meses) tratando el Concept Drift vs Sin tratar.</h4>
<pre><code class="language-python">fig, axes = plt.subplots(nrows=4, ncols=5, figsize=(28, 17))
i = 0
for row in axes:
    for ax in row:
        label=data_orig.columns[i]
        ax.set_title(label)
        df_error_mae_un_mes_baseline_con_concept[label].plot(ax=ax)
        df_error_mae_dos_meses_baseline_con_concept[label].plot(ax=ax)
        df_error_mae_tres_meses_baseline_con_concept[label].plot(ax=ax)
        df_error_mae_un_mes_baseline_sin_concept[label].plot(ax=ax)
        df_error_mae_dos_meses_baseline_sin_concept[label].plot(ax=ax)
        df_error_mae_tres_meses_baseline_sin_concept[label].plot(ax=ax)
        ax.set_xlabel(label_num_casos)
        ax.set_ylabel(&quot;MAE&quot;)
        ax.legend([&quot;Bline Un Mes trat concept&quot;, &quot;Bline Dos Meses trat concept&quot;,&quot;Bline tres Meses trat concept&quot;,&quot;Bline Un M sin&quot;, &quot;Bline Dos M sin&quot;,&quot;Bline tres M sin&quot;]);
        i += 1
fig.suptitle(&quot;Comparación de la métrica de error seleccionada (MAE) Modelo Baseline, tratando outliers  vs sin tratar los outliers, para cada ciudad&quot;, fontsize=20)
plt.tight_layout()
plt.show()
</code></pre>
<p><img src="output_88_0.png" alt="png" /></p>
<h3 id="tabla-de-resultados">2.2.8 Tabla de Resultados</h3>
<pre><code class="language-python">df_datos_largo_plazo.sort_index(ascending=True)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BUDAPEST</th>
      <th>BARANYA</th>
      <th>BACS</th>
      <th>BEKES</th>
      <th>BORSOD</th>
      <th>CSONGRAD</th>
      <th>FEJER</th>
      <th>GYOR</th>
      <th>HAJDU</th>
      <th>HEVES</th>
      <th>JASZ</th>
      <th>KOMAROM</th>
      <th>NOGRAD</th>
      <th>PEST</th>
      <th>SOMOGY</th>
      <th>SZABOLCS</th>
      <th>TOLNA</th>
      <th>VAS</th>
      <th>VESZPREM</th>
      <th>ZALA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1 MAE Datos sin drift y sin tratar outliers con horizonte=  12 semanas, modelo = baseline</th>
      <td>74.22</td>
      <td>36.48</td>
      <td>35.51</td>
      <td>80.33</td>
      <td>57.38</td>
      <td>34.93</td>
      <td>87.64</td>
      <td>59.85</td>
      <td>85.85</td>
      <td>30.6</td>
      <td>60.59</td>
      <td>27.31</td>
      <td>36.34</td>
      <td>76.4</td>
      <td>34.01</td>
      <td>47.17</td>
      <td>50.84</td>
      <td>34.8</td>
      <td>44.49</td>
      <td>46.47</td>
    </tr>
    <tr>
      <th>1 MAE Datos sin drift y sin tratar outliers con horizonte=  12 semanas, modelo = snarimax</th>
      <td>62.91</td>
      <td>25.99</td>
      <td>31.11</td>
      <td>28.72</td>
      <td>40.05</td>
      <td>26.35</td>
      <td>24.08</td>
      <td>30.03</td>
      <td>36.38</td>
      <td>25.86</td>
      <td>32.98</td>
      <td>23.21</td>
      <td>18.48</td>
      <td>53.8</td>
      <td>23.43</td>
      <td>27.02</td>
      <td>17.77</td>
      <td>19.71</td>
      <td>35.52</td>
      <td>17.08</td>
    </tr>
    <tr>
      <th>1 MAE Datos sin drift y sin tratar outliers con horizonte=  4 semanas, modelo = baseline</th>
      <td>45.55</td>
      <td>23.68</td>
      <td>23.12</td>
      <td>53.16</td>
      <td>38.94</td>
      <td>22.3</td>
      <td>54.59</td>
      <td>37.12</td>
      <td>54.4</td>
      <td>20.16</td>
      <td>40.54</td>
      <td>19.0</td>
      <td>23.73</td>
      <td>48.62</td>
      <td>21.24</td>
      <td>32.87</td>
      <td>32.57</td>
      <td>21.9</td>
      <td>27.96</td>
      <td>29.18</td>
    </tr>
    <tr>
      <th>1 MAE Datos sin drift y sin tratar outliers con horizonte=  4 semanas, modelo = snarimax</th>
      <td>41.88</td>
      <td>18.1</td>
      <td>22.03</td>
      <td>24.06</td>
      <td>32.09</td>
      <td>19.39</td>
      <td>17.61</td>
      <td>20.56</td>
      <td>27.33</td>
      <td>18.25</td>
      <td>22.88</td>
      <td>17.4</td>
      <td>13.87</td>
      <td>35.91</td>
      <td>16.67</td>
      <td>22.5</td>
      <td>13.33</td>
      <td>15.37</td>
      <td>24.6</td>
      <td>13.05</td>
    </tr>
    <tr>
      <th>1 MAE Datos sin drift y sin tratar outliers con horizonte=  8 semanas, modelo = baseline</th>
      <td>60.24</td>
      <td>30.0</td>
      <td>29.18</td>
      <td>66.31</td>
      <td>49.83</td>
      <td>29.49</td>
      <td>72.91</td>
      <td>49.43</td>
      <td>72.74</td>
      <td>25.7</td>
      <td>52.97</td>
      <td>23.39</td>
      <td>30.39</td>
      <td>63.23</td>
      <td>26.9</td>
      <td>40.59</td>
      <td>43.22</td>
      <td>29.16</td>
      <td>34.54</td>
      <td>38.75</td>
    </tr>
    <tr>
      <th>1 MAE Datos sin drift y sin tratar outliers con horizonte=  8 semanas, modelo = snarimax</th>
      <td>51.75</td>
      <td>21.8</td>
      <td>26.77</td>
      <td>26.36</td>
      <td>35.64</td>
      <td>22.45</td>
      <td>20.73</td>
      <td>24.74</td>
      <td>32.11</td>
      <td>22.4</td>
      <td>28.28</td>
      <td>20.32</td>
      <td>16.38</td>
      <td>44.22</td>
      <td>20.12</td>
      <td>24.94</td>
      <td>15.59</td>
      <td>17.35</td>
      <td>29.88</td>
      <td>15.25</td>
    </tr>
    <tr>
      <th>2 MAE Datos sin drift y tratando outliers con horizonte=  12 semanas, modelo = baseline</th>
      <td>70.98</td>
      <td>35.31</td>
      <td>33.92</td>
      <td>29.0</td>
      <td>55.48</td>
      <td>33.06</td>
      <td>56.11</td>
      <td>64.87</td>
      <td>93.39</td>
      <td>28.87</td>
      <td>63.6</td>
      <td>26.03</td>
      <td>35.64</td>
      <td>75.17</td>
      <td>32.94</td>
      <td>47.86</td>
      <td>50.0</td>
      <td>32.52</td>
      <td>41.86</td>
      <td>46.74</td>
    </tr>
    <tr>
      <th>2 MAE Datos sin drift y tratando outliers con horizonte=  12 semanas, modelo = snarimax</th>
      <td>61.61</td>
      <td>25.32</td>
      <td>30.17</td>
      <td>25.6</td>
      <td>38.42</td>
      <td>25.27</td>
      <td>23.85</td>
      <td>29.85</td>
      <td>34.99</td>
      <td>24.74</td>
      <td>31.19</td>
      <td>21.78</td>
      <td>17.98</td>
      <td>53.71</td>
      <td>22.11</td>
      <td>25.22</td>
      <td>17.2</td>
      <td>18.23</td>
      <td>33.63</td>
      <td>16.79</td>
    </tr>
    <tr>
      <th>2 MAE Datos sin drift y tratando outliers con horizonte=  4 semanas, modelo = baseline</th>
      <td>44.03</td>
      <td>23.13</td>
      <td>22.17</td>
      <td>19.78</td>
      <td>36.9</td>
      <td>21.29</td>
      <td>34.14</td>
      <td>38.29</td>
      <td>57.74</td>
      <td>19.26</td>
      <td>41.79</td>
      <td>18.44</td>
      <td>23.36</td>
      <td>47.7</td>
      <td>20.7</td>
      <td>32.79</td>
      <td>32.06</td>
      <td>20.5</td>
      <td>26.91</td>
      <td>29.19</td>
    </tr>
    <tr>
      <th>2 MAE Datos sin drift y tratando outliers con horizonte=  4 semanas, modelo = snarimax</th>
      <td>40.9</td>
      <td>17.6</td>
      <td>21.34</td>
      <td>18.5</td>
      <td>30.73</td>
      <td>18.69</td>
      <td>17.5</td>
      <td>20.14</td>
      <td>26.76</td>
      <td>17.58</td>
      <td>22.14</td>
      <td>16.67</td>
      <td>13.52</td>
      <td>35.42</td>
      <td>15.52</td>
      <td>21.05</td>
      <td>12.91</td>
      <td>14.2</td>
      <td>23.68</td>
      <td>12.84</td>
    </tr>
    <tr>
      <th>2 MAE Datos sin drift y tratando outliers con horizonte=  8 semanas, modelo = baseline</th>
      <td>57.86</td>
      <td>29.12</td>
      <td>27.88</td>
      <td>24.02</td>
      <td>47.54</td>
      <td>28.15</td>
      <td>47.85</td>
      <td>53.53</td>
      <td>77.18</td>
      <td>24.53</td>
      <td>55.09</td>
      <td>22.5</td>
      <td>29.92</td>
      <td>62.18</td>
      <td>26.23</td>
      <td>40.9</td>
      <td>42.59</td>
      <td>27.41</td>
      <td>32.69</td>
      <td>38.9</td>
    </tr>
    <tr>
      <th>2 MAE Datos sin drift y tratando outliers con horizonte=  8 semanas, modelo = snarimax</th>
      <td>50.74</td>
      <td>21.2</td>
      <td>25.93</td>
      <td>21.72</td>
      <td>34.28</td>
      <td>21.6</td>
      <td>20.55</td>
      <td>24.42</td>
      <td>30.97</td>
      <td>21.55</td>
      <td>27.02</td>
      <td>19.3</td>
      <td>15.98</td>
      <td>44.07</td>
      <td>18.58</td>
      <td>23.4</td>
      <td>15.11</td>
      <td>16.15</td>
      <td>28.47</td>
      <td>15.02</td>
    </tr>
    <tr>
      <th>3 MAE Datos con drift en datos y tratando el drift con horizonte=  12 semanas modelo: baseline</th>
      <td>53.85</td>
      <td>27.32</td>
      <td>23.67</td>
      <td>21.81</td>
      <td>86.67</td>
      <td>24.02</td>
      <td>52.08</td>
      <td>59.02</td>
      <td>40.02</td>
      <td>21.82</td>
      <td>30.06</td>
      <td>20.11</td>
      <td>30.87</td>
      <td>58.78</td>
      <td>27.4</td>
      <td>39.77</td>
      <td>43.36</td>
      <td>27.8</td>
      <td>34.01</td>
      <td>42.21</td>
    </tr>
    <tr>
      <th>3 MAE Datos con drift en datos y tratando el drift con horizonte=  12 semanas modelo: snarimax</th>
      <td>46.27</td>
      <td>18.1</td>
      <td>21.13</td>
      <td>18.88</td>
      <td>29.19</td>
      <td>17.98</td>
      <td>18.04</td>
      <td>22.19</td>
      <td>25.21</td>
      <td>18.6</td>
      <td>22.66</td>
      <td>15.72</td>
      <td>14.08</td>
      <td>39.82</td>
      <td>16.6</td>
      <td>18.91</td>
      <td>12.64</td>
      <td>13.81</td>
      <td>25.29</td>
      <td>13.42</td>
    </tr>
    <tr>
      <th>3 MAE Datos con drift en datos y tratando el drift con horizonte=  4 semanas modelo: baseline</th>
      <td>32.12</td>
      <td>17.62</td>
      <td>15.34</td>
      <td>14.59</td>
      <td>52.49</td>
      <td>15.39</td>
      <td>28.45</td>
      <td>33.06</td>
      <td>23.37</td>
      <td>13.85</td>
      <td>20.65</td>
      <td>13.97</td>
      <td>19.78</td>
      <td>36.59</td>
      <td>16.76</td>
      <td>26.96</td>
      <td>27.7</td>
      <td>16.35</td>
      <td>20.32</td>
      <td>25.61</td>
    </tr>
    <tr>
      <th>3 MAE Datos con drift en datos y tratando el drift con horizonte=  4 semanas modelo: snarimax</th>
      <td>29.51</td>
      <td>12.32</td>
      <td>14.87</td>
      <td>13.34</td>
      <td>23.27</td>
      <td>13.37</td>
      <td>12.53</td>
      <td>14.24</td>
      <td>19.1</td>
      <td>12.5</td>
      <td>15.89</td>
      <td>12.21</td>
      <td>10.24</td>
      <td>25.06</td>
      <td>11.18</td>
      <td>15.83</td>
      <td>9.34</td>
      <td>11.12</td>
      <td>17.12</td>
      <td>9.61</td>
    </tr>
    <tr>
      <th>3 MAE Datos con drift en datos y tratando el drift con horizonte=  8 semanas modelo: baseline</th>
      <td>43.36</td>
      <td>22.62</td>
      <td>19.29</td>
      <td>17.59</td>
      <td>70.86</td>
      <td>20.6</td>
      <td>41.16</td>
      <td>47.08</td>
      <td>32.09</td>
      <td>18.47</td>
      <td>26.75</td>
      <td>17.16</td>
      <td>25.6</td>
      <td>49.05</td>
      <td>21.84</td>
      <td>34.34</td>
      <td>37.34</td>
      <td>21.71</td>
      <td>26.7</td>
      <td>35.08</td>
    </tr>
    <tr>
      <th>3 MAE Datos con drift en datos y tratando el drift con horizonte=  8 semanas modelo: snarimax</th>
      <td>37.38</td>
      <td>15.08</td>
      <td>18.03</td>
      <td>15.55</td>
      <td>25.73</td>
      <td>15.18</td>
      <td>15.19</td>
      <td>18.07</td>
      <td>22.32</td>
      <td>15.87</td>
      <td>19.68</td>
      <td>14.08</td>
      <td>12.42</td>
      <td>31.84</td>
      <td>13.49</td>
      <td>17.6</td>
      <td>11.03</td>
      <td>12.35</td>
      <td>20.86</td>
      <td>11.72</td>
    </tr>
    <tr>
      <th>4 MAE Datos con drift en datos y sin tratar el drift con horizonte=  12 semanas modelo: baseline</th>
      <td>57.54</td>
      <td>28.62</td>
      <td>25.62</td>
      <td>23.33</td>
      <td>89.89</td>
      <td>25.9</td>
      <td>55.09</td>
      <td>61.53</td>
      <td>42.98</td>
      <td>23.57</td>
      <td>31.6</td>
      <td>21.09</td>
      <td>32.15</td>
      <td>62.46</td>
      <td>28.71</td>
      <td>41.72</td>
      <td>45.44</td>
      <td>29.14</td>
      <td>36.01</td>
      <td>43.99</td>
    </tr>
    <tr>
      <th>4 MAE Datos con drift en datos y sin tratar el drift con horizonte=  12 semanas modelo: snarimax</th>
      <td>49.8</td>
      <td>19.38</td>
      <td>22.99</td>
      <td>20.11</td>
      <td>30.82</td>
      <td>19.14</td>
      <td>19.12</td>
      <td>23.96</td>
      <td>26.66</td>
      <td>19.99</td>
      <td>24.21</td>
      <td>16.61</td>
      <td>14.8</td>
      <td>42.76</td>
      <td>17.84</td>
      <td>19.67</td>
      <td>13.28</td>
      <td>14.73</td>
      <td>27.54</td>
      <td>14.01</td>
    </tr>
    <tr>
      <th>4 MAE Datos con drift en datos y sin tratar el drift con horizonte=  4 semanas modelo: baseline</th>
      <td>35.21</td>
      <td>18.92</td>
      <td>16.98</td>
      <td>15.77</td>
      <td>54.67</td>
      <td>16.46</td>
      <td>30.08</td>
      <td>34.77</td>
      <td>25.55</td>
      <td>15.51</td>
      <td>22.74</td>
      <td>15.13</td>
      <td>20.8</td>
      <td>39.81</td>
      <td>17.75</td>
      <td>28.37</td>
      <td>29.15</td>
      <td>16.97</td>
      <td>22.88</td>
      <td>27.02</td>
    </tr>
    <tr>
      <th>4 MAE Datos con drift en datos y sin tratar el drift con horizonte=  4 semanas modelo: snarimax</th>
      <td>32.62</td>
      <td>13.54</td>
      <td>16.57</td>
      <td>14.41</td>
      <td>24.73</td>
      <td>14.17</td>
      <td>13.96</td>
      <td>16.33</td>
      <td>20.78</td>
      <td>13.94</td>
      <td>17.71</td>
      <td>13.19</td>
      <td>11.08</td>
      <td>27.8</td>
      <td>12.16</td>
      <td>16.81</td>
      <td>10.03</td>
      <td>11.64</td>
      <td>19.34</td>
      <td>10.63</td>
    </tr>
    <tr>
      <th>4 MAE Datos con drift en datos y sin tratar el drift con horizonte=  8 semanas modelo: baseline</th>
      <td>46.94</td>
      <td>23.78</td>
      <td>21.08</td>
      <td>19.14</td>
      <td>73.45</td>
      <td>22.25</td>
      <td>43.92</td>
      <td>49.05</td>
      <td>34.94</td>
      <td>20.07</td>
      <td>28.45</td>
      <td>18.27</td>
      <td>26.98</td>
      <td>52.13</td>
      <td>22.94</td>
      <td>35.68</td>
      <td>38.98</td>
      <td>23.2</td>
      <td>29.68</td>
      <td>36.47</td>
    </tr>
    <tr>
      <th>4 MAE Datos con drift en datos y sin tratar el drift con horizonte=  8 semanas modelo: snarimax</th>
      <td>40.74</td>
      <td>16.24</td>
      <td>19.97</td>
      <td>16.9</td>
      <td>27.44</td>
      <td>16.27</td>
      <td>16.48</td>
      <td>19.81</td>
      <td>23.85</td>
      <td>17.38</td>
      <td>21.33</td>
      <td>15.01</td>
      <td>13.22</td>
      <td>34.95</td>
      <td>14.67</td>
      <td>18.54</td>
      <td>11.75</td>
      <td>13.01</td>
      <td>22.95</td>
      <td>12.53</td>
    </tr>
    <tr>
      <th>5 Num Drifts Datos con drift en datos y tratando el drift con horizonte=  12 semanas modelo =baseline</th>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>5 Num Drifts Datos con drift en datos y tratando el drift con horizonte=  12 semanas modelo =snarimax</th>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>5 Num Drifts Datos con drift en datos y tratando el drift con horizonte=  4 semanas modelo =baseline</th>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>5 Num Drifts Datos con drift en datos y tratando el drift con horizonte=  4 semanas modelo =snarimax</th>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>5 Num Drifts Datos con drift en datos y tratando el drift con horizonte=  8 semanas modelo =baseline</th>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>5 Num Drifts Datos con drift en datos y tratando el drift con horizonte=  8 semanas modelo =snarimax</th>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>MEAN</th>
      <td>73.63</td>
      <td>24.37</td>
      <td>26.79</td>
      <td>21.89</td>
      <td>41.82</td>
      <td>22.21</td>
      <td>24.0</td>
      <td>30.64</td>
      <td>33.92</td>
      <td>22.28</td>
      <td>28.54</td>
      <td>17.88</td>
      <td>16.75</td>
      <td>62.45</td>
      <td>20.72</td>
      <td>21.08</td>
      <td>14.92</td>
      <td>16.77</td>
      <td>30.04</td>
      <td>14.87</td>
    </tr>
    <tr>
      <th>Num Outliers</th>
      <td>7</td>
      <td>8</td>
      <td>8</td>
      <td>11</td>
      <td>6</td>
      <td>11</td>
      <td>4</td>
      <td>5</td>
      <td>6</td>
      <td>10</td>
      <td>4</td>
      <td>4</td>
      <td>9</td>
      <td>4</td>
      <td>7</td>
      <td>7</td>
      <td>9</td>
      <td>11</td>
      <td>7</td>
      <td>6</td>
    </tr>
    <tr>
      <th>STD</th>
      <td>72.09</td>
      <td>28.23</td>
      <td>32.2</td>
      <td>35.89</td>
      <td>45.65</td>
      <td>28.55</td>
      <td>26.87</td>
      <td>33.84</td>
      <td>39.37</td>
      <td>30.33</td>
      <td>32.4</td>
      <td>21.36</td>
      <td>20.87</td>
      <td>60.49</td>
      <td>25.43</td>
      <td>25.12</td>
      <td>21.41</td>
      <td>21.05</td>
      <td>37.84</td>
      <td>20.55</td>
    </tr>
  </tbody>
</table>
</div>
<h3 id="conclusiones">2.2.9 Conclusiones</h3>
<ul>
<li>Para cada ciudad:</li>
</ul>
<blockquote>
<p>En este caso tenemos dos modelos con varios horizontes.El modelo <strong>SNARIMAX</strong> que ha sido configurado con sus parámetros a partir de los plots de Autocorrlación (ACF) y Autocorrelación Parcial (PACF)y otro modelo tomado como Baseline que es el <strong>Holtwinter</strong>, en el que también se han ajustado sus parámetros para un buen rendimiento. Lo primero que hay que destacar que a mayor horizonte los modelos predicen peor, tienen más error. Obviamente como en el caso del Nowcasting si se tratan los outliers se obtienen mejores prestaciones que si no se hace. Lo mismo ocurre con el drift. Se ha introducido un drift artificial para hacer estas comprobaciones con el detector de drifts ADWIN. Cada vez que se detecta un drift, tanto el modelo como el detector son reiniciados.</p>
</blockquote>
<ul>
<li>Comparando ciudades:</li>
</ul>
<blockquote>
<p>Comparando las mediciones entre ciudades, las ciudades que menor MAE presentan independientemente del modelo usado, aunque por supuesto hay diferencias entre modelos y siguen siendo los menores MAE aquellos que tratan los outliers y el drift. Como en la comparación en cada ciudad el modelo para cada ciudad el mejor modelo es el <strong>SNARIMAX</strong>
Al igual que con el Nowcating, las mejores ciudades, son aquellas que presentan una menor dispersión, menor desviación tipica y menor media, en los datos.
Estas ciudades son aquellas que presentan una menor población o han contraido un menor número de casos de varicela. A mayor dispersión en los datos, mayor es el error.</p>
</blockquote>

    </body>
</html>
            
